---
title: "Exploring the composition of lithic assemblages in Mesolithic south-eastern Norway"
author:
  - Isak Roalkvam:
      email: isak.roalkvam@iakh.uio.no
      institute: [UiO]
      correspondence: true
institute:
  - UiO: University of Oslo
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
    bookdown::word_document2:
      fig_caption: yes
      reference_docx: "../templates/template.docx" # Insert path for the DOCX file
      pandoc_args:
      - --lua-filter=../templates/scholarly-metadata.lua
      - --lua-filter=../templates/author-info-blocks.lua
      - --lua-filter=../templates/pagebreak.lua
bibliography: references.bib
csl: "../templates/journal-of-archaeological-science.csl" # Insert path for the bib-style
---

<!-- This is the format for text comments that will be ignored during renderings. Do not put R code in these comments because it will not be ignored. -->

<!-- The following code chunk defines some general settings how code chunks should behave. -->

```{r setup, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  echo = FALSE,
  comment = "#>",
  fig.path = "../figures/",
  dpi = 300
)
```

```{r libraries, eval = TRUE}
library(tidyverse)
library(FactoMineR)
library(factoextra)
```

<!-- Here's some example analysis code: -->

# Plots

```{r get-data, eval = TRUE}
sites <- read.csv(here::here('analysis/data/raw_data/Roalkvam_DialPast_March2021_data.csv'))

```

```{r wrangling}
sites <- sites %>% 
      # Find mean age for each site (to be used in the plot below)
  rowwise() %>% 
  mutate(mean_date = mean(c(reported_start_bp, reported_end_bp)),
         .keep = "unused") %>% 
  mutate(
    artefact_count = sum(c_across(core:flake_retouch_other))) %>% 
  filter(artefact_count > 100)
  

lithics <- sites %>%
  # Combine flint projectiles into a single variable
  mutate(
    projectile = microlith + tanged_point + transverse_point + 
    single_edged_point + hognipen_point + projectile_undefined,
    small_tool = scraper + knife + burin + drill + blade_retouch + 
      microblade_retouch + chip_retouch + fragment_retouch + flake_retouch,
    macro_tool = axe + chisel, 
    macro_tool_other = axe_other + chisel_other + club_hatchet_other,
    small_tool_other = knife_other + scraper_other + drill_other + 
      microblade_retouch_other + blade_retouch_other + fragment_retouch_other +
      flake_retouch_other,
    .keep = "unused") %>%
  # Make site names the rownames
  column_to_rownames(var = "site") %>% 
  # Deselect a few of the columns not be used
  select(-one_of(c("n", "excavation_project", "excavated_m3")))
```

```{r cor, fig.cap = "Correspondence analysis using artefact count data.", fig.height = 5, fig.width = 10}
# Perform correspondence analysis on the data. 'mean_age' is meant for colouring
# so is excluded here
calithics <- CA(select(lithics, -mean_date), graph = FALSE)

# Find date to hold the central tendency date
centdate <- mean(lithics$mean_date) / 1000

# Call to plot
fviz_ca_row(calithics, col.row = lithics$mean_date / 1000, title = "",
                     repel = TRUE) +
  scale_color_gradient2(name = "Years cal. BP", low="blue", mid="yellow", 
                        high="red", midpoint = centdate) +
  theme(legend.position = "bottom")

fviz_ca_col(calithics, col.col = "black", repel = TRUE, title = "") 

```

Figure \@ref(fig:cor) displays a correspondence analysis using the lithic count data.

```{r pcadata}
# Tried to do this to avoid having to type the variable names into both mutate()
# and select(). The general syntax select(-(vector_of_variable_names)) worked,
# but not: mutate(new_varaible = sum(vector_of_variable_names) / artefact_count)
primary_lithics <- c("core", "core_fragment", "blade", "microblade", "chip",
                     "fragment", "flake", "flake_other", "fragment_other", 
                     "chip_other", "blade_other",  "microblade_other", 
                     "core_other", "core_fragment_other")

secondary_lithics <- c("axe_debitage", "axe", "chisel", "microlith", 
"tanged_point", "transverse_point", "single_edged_point", "hognipen_point",
"projectile_undefined", "microburin", "scraper", "knife", "burin", "drill", 
"blade_retouch", "microblade_retouch", "chip_retouch", "fragment_retouch",
"flake_retouch", "axe_other", "axe_debitage_other", "chisel_other",
"club_hatchet_other", "grinding_slab_stone", "projectile_point_other",
"knife_other", "scraper_other", "drill_other", "microblade_retouch_other", 
"blade_retouch_other", "fragment_retouch_other", "flake_retouch_other")

lithics2 <- sites %>% 
  select(-n, -beach_flint_flint_nodule, -hammerstone, -excavation_project) %>% 
  # The reason for not using .keep below is for the option to retain artefact_count
  mutate(chip_freq =  sum(chip, chip_other) / artefact_count,
         core_freq = sum(core, core_other) / artefact_count,
         primary_freq = sum(core, core_fragment, blade, 
                     microblade, chip, fragment, flake, flake_other, 
                     fragment_other, chip_other, blade_other,  microblade_other, 
                     core_other, core_fragment_other) / artefact_count,
         secondary_freq =  sum(axe_debitage, axe, chisel, 
                microlith, tanged_point, transverse_point, single_edged_point,
                hognipen_point, projectile_undefined, microburin, scraper, 
                knife, burin, drill, blade_retouch, microblade_retouch, 
                chip_retouch, fragment_retouch, flake_retouch, axe_other,
                axe_debitage_other, chisel_other, club_hatchet_other, 
                grinding_slab_stone, projectile_point_other, knife_other,
                scraper_other, drill_other, microblade_retouch_other, 
                blade_retouch_other, fragment_retouch_other,
                flake_retouch_other) / artefact_count,
         lithic_dens = artefact_count / excavated_m3) %>%
  select(-primary_lithics, -secondary_lithics, -excavated_m3, -artefact_count) %>% 
  column_to_rownames("site")
```

```{r pca-analysis, fig.cap = "PCA.", fig.height = 7, fig.width = 10}
pcalithics <- PCA(select(lithics2, -mean_date), scale.unit = TRUE, graph = FALSE)
fviz_pca(pcalithics, col.ind = lithics2$mean_date / 1000, col.var = "black", 
         repel = TRUE) +  scale_color_gradient2(name = "Years cal. BP", 
         low="blue", mid="yellow", high="red", midpoint = centdate) +
  theme(legend.position = "bottom")

```

Figure \@ref(fig:pca-analysis) displays a principle components analysis using continuous measures as defined by @Bicho2020

<!-- The following line inserts a page break  -->

\newpage

# References

<!-- The following line ensures the references appear here for the MS Word or HTML output files, rather than right at the end of the document (this will not work for PDF files):  -->

::: {#refs}
:::

\newpage

### Colophon

This report was generated on `r Sys.time()` using the following computational environment and dependencies:

```{r colophon, cache = FALSE}
# which R packages and versions?
if ("devtools" %in% installed.packages()) devtools::session_info()
```

The current Git commit details are:

```{r}
# what commit is this file at? 
if ("git2r" %in% installed.packages() & git2r::in_repository(path = ".")) git2r::repository(here::here())  
```
